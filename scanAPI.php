<?php
    header('Content-type: text/javascript');
    
    $MD5_hashing = "";

    //Scannning File
    if(isset($_FILES['scan_file']['name'])){
        $file_name = $_FILES['scan_file']['name'];
        $file_temp = $_FILES['scan_file']['tmp_name'];
        $path = "Uploads/";
        $upload_image ="Uploads/".$file_name;
        move_uploaded_file($file_temp,$upload_image);

        $fname = 'C:\\xampp\\htdocs\\Malware\\Uploads\\'. "$file_name";
        //$fname = 'C:\\xampp\\htdocs\\Malware\\Uploads\\Account.docx';
        $command = escapeshellcmd('python C:\xampp\htdocs\Malware\hash_gen.py ' .$fname);
        $output = shell_exec($command);
        $array = explode(' ', $output);
        $MD5_hashing = $array[0];
        unlink("Uploads/".$file_name);
    }



    $post = array('apikey' => '18c6ccaa0fa365dccdbddb82eb2d21412bf866374cb7f5060f9b0fad5feeda3f','resource'=>"$MD5_hashing");
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, 'https://www.virustotal.com/vtapi/v2/file/report');
    curl_setopt($ch, CURLOPT_POST,1);
    curl_setopt($ch, CURLOPT_VERBOSE, 1); // remove this if your not debugging
    curl_setopt($ch, CURLOPT_ENCODING, 'gzip,deflate'); // please compress data
    curl_setopt($ch, CURLOPT_USERAGENT, "gzip, My php curl client");
    curl_setopt($ch, CURLOPT_RETURNTRANSFER ,true);
    curl_setopt($ch, CURLOPT_POSTFIELDS, $post);

    $result=curl_exec ($ch);
    $status_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    if ($status_code == 200) 
    { // OK
        $js = json_decode($result, true);
        if($js['verbose_msg'] == 'The requested resource is not among the finished, queued or pending scans')
        {
            echo '<img src="./Resource/img/safe.png" height="200px" width="200px">
                  <input id="md5_value" type="hidden" value="'.$MD5_hashing.'">';
        }else{
            echo '<img src="./Resource/img/danger.png" height="200px" width="200px">
                  <input id="md5_value" type="hidden" value="'.$MD5_hashing.'">';
        }
    //echo $result;
    } else {  // Error occured
        echo '<p>FAILED TO SCAN FILE </p>';
    }
    curl_close ($ch);
    
?>